import time

from pages.base import BasePage
from playwright.sync_api import Page
import json


class EcpPage(BasePage):

    ECP_BUTTON = "#sendEcp"
    WS_URL = 'wss://127.0.0.1:13579/'
    REAL_SIGNED_XML = '''"<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?><root><hub_form><id>63583</id><created_at>2025-11-13T12:56:20.857424+00:00</created_at><hub_form><id>299</id><name><en/><kk/><ru>Аккредитация переоформление для ФЛ</ru></name><description><en/><kk/><ru/><show>False</show></description><need_signature>True</need_signature><multilanguage>False</multilanguage><steps><item><id>1437</id><name><en>Personal data</en><kk>Жеке деректер</kk><ru>Личные данные</ru></name><position>0</position><fields><item><id>19781</id><title><en>Surname</en><kk>Тегі</kk><ru>Номер свидетельства</ru></title><key>cert_number</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>text</field_type><required>True</required><multiple_answers>True</multiple_answers><position>0</position><template>service/hub_form/fields/text.html</template><example/><data/><prefill_value/><value>00003</value><value_en/><value_kk/></item><item><id>19782</id><title><en>Name</en><kk>Аты</kk><ru>Дата выдачи свидетельства</ru></title><key>accreditation_given_date</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>date</field_type><required>True</required><multiple_answers>True</multiple_answers><position>1</position><template>service/hub_form/fields/date.html</template><example/><data/><prefill_value/><value>07.11.2025</value><value_en/><value_kk/></item><item><id>20565</id><title><en/><kk/><ru>Срок действия свидетельства</ru></title><key>accreditation_expiration_date</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/><show>False</show></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>date</field_type><required>True</required><multiple_answers>True</multiple_answers><position>2</position><template>service/hub_form/fields/date.html</template><example/><data/><prefill_value/><value>02.11.2025</value><value_en/><value_kk/></item><item><id>19783</id><title><en>Patronymic</en><kk>Әкесінің аты</kk><ru>ИИН</ru></title><key>iin_number</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>text</field_type><required>True</required><multiple_answers>True</multiple_answers><position>3</position><template>service/hub_form/fields/text.html</template><example/><data><max>12</max></data><prefill_value>{{ request.user.iin }}</prefill_value><value>990315351258</value><value_en/><value_kk/></item><item><id>20566</id><title><en/><kk/><ru>Новое ФИО на государственном языке</ru></title><key>new_fullname</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/><show>False</show></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>text</field_type><required>True</required><multiple_answers>True</multiple_answers><position>4</position><template>service/hub_form/fields/text.html</template><example/><data/><prefill_value/><value>Байсаганов Алишер Айбекович kaz</value><value_en/><value_kk/></item><item><id>19784</id><title><en>IIN</en><kk>ЖСН</kk><ru>Новое ФИО на русском языке</ru></title><key>fullname</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>text</field_type><required>True</required><multiple_answers>True</multiple_answers><position>5</position><template>service/hub_form/fields/text.html</template><example/><data/><prefill_value>{{ request.user.first_name }}</prefill_value><value>Alisher</value><value_en/><value_kk/></item><item><id>19785</id><title><en>Contact phone number</en><kk>Байланыс телефон нөмірі</kk><ru>Контактный номер телефона</ru></title><key>mobile_phone_number</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>phone</field_type><required>True</required><multiple_answers>True</multiple_answers><position>6</position><template>service/hub_form/fields/phone.html</template><example/><data/><prefill_value>{{ request.user.phone }}</prefill_value><value>+7 (213) 456 - 78 - 9_</value><value_en/><value_kk/></item><item><id>19786</id><title><en>Email</en><kk>Электрондық пошта</kk><ru>Эл. почта</ru></title><key>email_field</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>email</field_type><required>True</required><multiple_answers>True</multiple_answers><position>7</position><template>service/hub_form/fields/email.html</template><example/><data/><prefill_value>{{ request.user.email }}</prefill_value><value>a.baisaganov@astanahub.com</value><value_en/><value_kk/></item><item><id>19826</id><title><en/><kk/><ru>Копия документа об изменении ФИО</ru></title><key>change_accept_copy</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>file</field_type><required>True</required><multiple_answers>True</multiple_answers><position>8</position><template>service/hub_form/fields/file.html</template><example/><data><types><item>DOC(X)</item><item>PDF</item></types></data><prefill_value/><value><id>bcffbd6c-691e-47be-ba52-b2eabf60e5f2</id><file>https://dev.astanahub.com/account/api/protected_media_file/bcffbd6c-691e-47be-ba52-b2eabf60e5f2/</file><url>https://dev.astanahub.com/account/api/protected_media_file/bcffbd6c-691e-47be-ba52-b2eabf60e5f2/</url><name>test_pdf_64kb_копия.d68bf8e1f51b_ELXAR3A.pdf</name></value><value_en/><value_kk/></item><item><id>19827</id><title><en/><kk/><ru>Копия ранее выданного свидетельства</ru></title><key>cert_copy</key><group/><subtitle><en/><kk/><ru/><show>False</show></subtitle><placeholder><en/><kk/><ru/><show>False</show></placeholder><helper_text><en/><kk/><ru/></helper_text><error_message><en/><kk/><ru/><show>False</show></error_message><field_type>file</field_type><required>True</required><multiple_answers>True</multiple_answers><position>9</position><template>service/hub_form/fields/file.html</template><example/><data><types><item>PDF</item><item>DOC(X)</item></types></data><prefill_value/><value><id>6436303f-b979-4002-9c88-ee47254dc94c</id><file>https://dev.astanahub.com/account/api/protected_media_file/6436303f-b979-4002-9c88-ee47254dc94c/</file><url>https://dev.astanahub.com/account/api/protected_media_file/6436303f-b979-4002-9c88-ee47254dc94c/</url><name>test_pdf_64kb_копия.d68bf8e1f51b_oE7o8IR.pdf</name></value><value_en/><value_kk/></item></fields></item></steps><extra_js>// $('input[name=\"iin_number\"]').prop('disabled', true);\n// $('input[readonly]').removeAttr('readonly');\n// $('input[name=\"iin_number\"]').attr('readonly', true);\n\n$('input[name=\"cert_number\"]').on('input', function () {\n  this.value = this.value.replace(/\\D/g, '');\n});\n\nfunction getDataByCertNumber(certNumber, section, input) {\n  const url = `/service/api/fl-accreditation-requests/${certNumber}/`;\n\n  input.siblings('.cert-error').remove();\n\n  $.serverRequest(url, \"\", 'GET')\n    .done(function (res) {\n      section.find('input[name=\"accreditation_given_date\"]').val(res.accreditation_given_date.split(\"-\").reverse().join(\".\"));\n      section.find('input[name=\"fullname\"]').val(res.user_full_name);\n      section.find('input[name=\"accreditation_expiration_date\"]').val(res.accreditation_expiration_date.split(\"-\").reverse().join(\".\"));\n\n    })\n    .fail(function (err) {\n      console.log(err);\n\n      const errorDiv = $('&lt;div/&gt;', {\n        class: 'cert-error',\n        text: 'Данные не найдены в реестре. Проверьте номер свидетельства',\n        css: {\n              borderRadius: '8px',\n              border: '1px solid #FFBFCC',\n              background: '#FFD5DD',\n              color: '#CC2243',\n              fontSize: '12px',\n              fontStyle: 'normal',\n              fontWeight: '400',\n              lineHeight: '16px',\n              padding: '8px',\n              marginTop: '8px'\n        }\n      });\n\n      input.after(errorDiv);\n    });\n}\n\n$('input[name=\"cert_number\"]').each(function () {\n  const input = $(this);\n  const parentDiv = input.closest('div');\n  const section = input.closest('section');\n\n  const uuid = uuidv4();\n\n  const textDiv = $('&lt;div/&gt;', {\n    text: 'Проверьте данные в реестре аккредитованных субъектов',\n    class: 'check-text',\n    css: {\n      color: '#1C1C1C',\n      fontSize: '14px',\n      fontStyle: 'normal',\n      fontWeight: '400',\n      lineHeight: '20px',\n    }\n  });\n\n  const button = $('&lt;div/&gt;', {\n    text: 'Проверить',\n    id: uuid,\n    class: 'btn',\n    css: {\n      margin: '0px',\n      padding: '4px 12px',\n      minHeight: 'auto',\n      lineHeight: '24px',\n    },\n    click: function () {\n      const certNumber = input.val();\n      getDataByCertNumber(certNumber, section, input);\n    },\n  });\n\n  const wrapper = $('&lt;div/&gt;', {\n    class: 'check-wrapper',\n    css: {\n      display: 'flex',\n      padding: '8px',\n      alignItems: 'center',\n      justifyContent: 'space-between',\n      borderRadius: '12px',\n      border: '1px solid #E3E3E3',\n      background: '#F4F4F4',\n\t  marginTop: '16px',\n    }\n  }).append(textDiv, button);\n\n  parentDiv.append(wrapper);\n});</extra_js><extra_css/></hub_form><data><fullname>Alisher</fullname><auto_save>False</auto_save><cert_copy>6436303f-b979-4002-9c88-ee47254dc94c</cert_copy><iin_number>990315351258</iin_number><cert_number>00003</cert_number><email_field>a.baisaganov@astanahub.com</email_field><new_fullname>Байсаганов Алишер Айбекович kaz</new_fullname><change_accept_copy>bcffbd6c-691e-47be-ba52-b2eabf60e5f2</change_accept_copy><mobile_phone_number>+7 (213) 456 - 78 - 9_</mobile_phone_number><accreditation_given_date>07.11.2025</accreditation_given_date><accreditation_expiration_date>02.11.2025</accreditation_expiration_date></data><data_en/><data_kk/><signature/><votes><votes/><count><yes>0</yes><no>0</no><refuse>0</refuse></count></votes></hub_form><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\n<ds:SignedInfo>\n<ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\"/>\n<ds:SignatureMethod Algorithm=\"urn:ietf:params:xml:ns:pkigovkz:xmlsec:algorithms:gostr34102015-gostr34112015-512\"/>\n<ds:Reference URI=\"\">\n<ds:Transforms>\n<ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/>\n<ds:Transform Algorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments\"/>\n</ds:Transforms>\n<ds:DigestMethod Algorithm=\"urn:ietf:params:xml:ns:pkigovkz:xmlsec:algorithms:gostr34112015-512\"/>\n<ds:DigestValue>9UuS/kUXgib58UHgQhz07BjfOpbDJ+RK0ce8TkbQaIvJYRLDm7p551F99Iip53VlURMaEkhVoq9U\nJ+RbqFNkdw==</ds:DigestValue>\n</ds:Reference>\n</ds:SignedInfo>\n<ds:SignatureValue>\ns2nsNGPRn27O8/dDkQ+9QqW2i1VZISylLx5EY1m/swSkfqnVXte5HbfWRchbvlFMWC5xPXzNHsO7\n45G8KkVMQQYf/VqS5TS8nQ73+U+A2Ncvg9lDjCsQNCkgR2deyiy2i8i55Kkd/b2KQw1cvKfAqeuu\nMOfyv4ElgyOBMt4Km1g=\n</ds:SignatureValue>\n<ds:KeyInfo>\n<ds:X509Data>\n<ds:X509Certificate>\nMIIEVDCCA7ygAwIBAgIUXdgD0qy7jUWW6HFmM5JfxeEsBvQwDgYKKoMOAwoBAQIDAgUAMFgxSTBH\nBgNVBAMMQNKw0JvQotCi0KvSmiDQmtCj05jQm9CQ0J3QlNCr0KDQo9Co0Ksg0J7QoNCi0JDQm9Cr\n0pogKEdPU1QpIDIwMjIxCzAJBgNVBAYTAktaMB4XDTI1MDUxNjEzMDkzOVoXDTI2MDUxNjEzMDkz\nOVowgY8xKjAoBgNVBAMMIdCR0JDQmdCh0JDQk9CQ0J3QntCSINCQ0JvQmNCo0JXQoDEdMBsGA1UE\nBAwU0JHQkNCZ0KHQkNCT0JDQndCe0JIxGDAWBgNVBAUTD0lJTjk5MDMxNTM1MTI1ODELMAkGA1UE\nBhMCS1oxGzAZBgNVBCoMEtCQ0JnQkdCV0JrQntCS0JjQpzCBrDAjBgkqgw4DCgEBAgIwFgYKKoMO\nAwoBAQICAQYIKoMOAwoBAwMDgYQABIGAjkkOxMyl/nSL+n/tVgdcqxAdXu08X5X4eIaZCTE6DOeO\n3MlM1D984lINnKK+HY81Mupe3riiloJ3z1x747GzOe1VgB71eAOFTo6JSb/1P7EnyjJr9suax95e\niB9wAmdPzxgHklZxzg4evWdvg7g2LUV/jL7Om2QoNd6eUtCuNyCjggHSMIIBzjAOBgNVHQ8BAf8E\nBAMCA8gwJwYDVR0lBCAwHgYIKoMOAwMEAwIGCCsGAQUFBwMEBggqgw4DAwQBATA4BgNVHSAEMTAv\nMC0GBiqDDgMDAjAjMCEGCCsGAQUFBwIBFhVodHRwOi8vcGtpLmdvdi5rei9jcHMwOAYDVR0fBDEw\nLzAtoCugKYYnaHR0cDovL2NybC5wa2kuZ292Lmt6L25jYV9nb3N0XzIwMjIuY3JsMDoGA1UdLgQz\nMDEwL6AtoCuGKWh0dHA6Ly9jcmwucGtpLmdvdi5rei9uY2FfZF9nb3N0XzIwMjIuY3JsMGgGCCsG\nAQUFBwEBBFwwWjAiBggrBgEFBQcwAYYWaHR0cDovL29jc3AucGtpLmdvdi5rejA0BggrBgEFBQcw\nAoYoaHR0cDovL3BraS5nb3Yua3ovY2VydC9uY2FfZ29zdF8yMDIyLmNlcjAhBgNVHREEGjAYgRZi\nYWlzYWdhbm92OTlAZ21haWwuY29tMB0GA1UdDgQWBBTd2APSrLuNRZbocWYzkl/F4SwG9DAfBgNV\nHSMEGDAWgBT+ML6fyJBjPx//WjwMsMhfTG0XCDAWBgYqgw4DAwUEDDAKBggqgw4DAwUBATAOBgoq\ngw4DCgEBAgMCBQADgYEAsZ/HQ2NTi+cVYwuBqkIheubvN8KO65a3T5SxcWMUMJztqdrUkD2F1Ubj\nFYVEo2gTR1OjI+9ienrOzpKrCzaaY1+n66TWJPoCxl4YJ65b8R3zuecvyUt04lqXwT6/iyiY1rfF\nvUC4my6TicAqVABsNT9LtKJgcmpK3BJ7sCo4tRM=\n</ds:X509Certificate>\n</ds:X509Data>\n</ds:KeyInfo>\n</ds:Signature></root>"'''

    def __init__(self, page: Page):
        super().__init__(page)
        self.setup_nca_with_real_signature()

    def setup_nca_with_real_signature(self):
        """Используем реальную подписанную XML"""

        script = f"""
        var OriginalWebSocket = window.WebSocket;
        var REAL_SIGNED_XML = {repr(self.REAL_SIGNED_XML)};

        window.WebSocket = class extends OriginalWebSocket {{
            constructor(url) {{
                if (url && url.includes('127.0.0.1:13579')) {{
                    var mockWs = {{
                        readyState: 1,

                        send: function(data) {{
                            var cmd = JSON.parse(data);
                            var response;

                            if (cmd.method === 'getActiveTokens' || 
                                cmd.method === 'getActiveTokens') {{
                                response = {{"code": "200", "responseObject": []}};
                            }} else if (cmd.method === 'signXmls' || cmd.method === 'signXml') {{
                                // Используем РЕАЛЬНУЮ подписанную XML
                                response = {{
                                    "code": "200",
                                    "responseObject": [REAL_SIGNED_XML]
                                }};
                            }}

                            if (this.onmessage) {{
                                setTimeout(() => {{
                                    this.onmessage({{data: JSON.stringify(response)}});
                                }}, 100);
                            }}
                        }},

                        close: function() {{
                            this.readyState = 3;
                            if (this.onclose) this.onclose({{wasClean: true}});
                        }},

                        onopen: null,
                        onmessage: null,
                        onclose: null
                    }};

                    window.webSocket = mockWs;
                    setTimeout(() => {{ if (mockWs.onopen) mockWs.onopen(); }}, 50);

                    return mockWs;
                }} else {{
                    return super(url);
                }}
            }}
        }};
        """

        self.page.add_init_script(script)
