name: Tests

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Run Tests via docker compose
        env:
          HEADLESS: ${{ secrets.HEADLESS }}
          BROWSER: ${{ secrets.BROWSER }}
          SLOW_MO: ${{ secrets.SLOW_MO }}
          TIMEOUT: ${{ secrets.TIMEOUT }}
          NAVIGATION_TIMEOUT: ${{ secrets.NAVIGATION_TIMEOUT }}
          VIEWPORT_WIDTH: ${{ secrets.VIEWPORT_WIDTH }}
          VIEWPORT_HEIGHT: ${{ secrets.VIEWPORT_HEIGHT }}
          USER_AGENT: ${{ secrets.USER_AGENT }}
          LOCALE: ${{ secrets.LOCALE }}
          TIMEZONE: ${{ secrets.TIMEZONE }}
          TRACE: ${{ secrets.TRACE }}
          SCREENSHOT: ${{ secrets.SCREENSHOT }}
          VIDEO: ${{ secrets.VIDEO }}
          DOWNLOADS_PATH: ${{ secrets.DOWNLOADS_PATH}}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          API_TIMEOUT: ${{ secrets.API_TIMEOUT }}
          API_RETRY_ATTEMPTS: ${{ secrets.API_RETRY_ATTEMPTS }}
          API_RETRY_DELAY: ${{ secrets.API_RETRY_DELAY }}
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
          ADMIN_URL: ${{ secrets.ADMIN_URL }}
          ENV: ${{ secrets.ENV }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          docker compose up --exit-code-from tests || true

      - name: Generate Allure Report
        run: |
          sudo docker compose run tests /bin/sh -c "allure generate allure-results --clean -o allure-report"

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true

      - name: Parse Allure report stats
        run: |
          docker compose run -v ${{ github.workspace }}:/workspace tests /bin/sh -c "
            apt-get update && apt-get install -y jq
            STAT=\$(cat allure-report/widgets/summary.json)
            PASSED=\$(echo \"\$STAT\" | jq '.statistic.passed')
            FAILED=\$(echo \"\$STAT\" | jq '.statistic.failed')
            SKIPPED=\$(echo \"\$STAT\" | jq '.statistic.skipped')
            BROKEN=\$(echo \"\$STAT\" | jq '.statistic.broken')
            DURATION_MS=\$(echo \"\$STAT\" | jq '.time.duration')
            DURATION_MIN=\$((DURATION_MS / 1000 / 60))
            DURATION_SEC=(((DURATION_MS - DURATION_MIN * 60 * 1000) / 1000))
            NOW=\$(date -d '+5 hours' +'%Y-%m-%d %H:%M:%S')

            # ÐŸÐ¸ÑˆÐµÐ¼ Ð² Ñ„Ð°Ð¹Ð» Ð½Ð° Ñ…Ð¾ÑÑ‚Ðµ
            cat > /workspace/report-stats.env << EOF
            PASSED=\$PASSED
            FAILED=\$FAILED
            SKIPPED=\$SKIPPED
            BROKEN=\$BROKEN
            DURATION_MIN=\$DURATION_MIN
            DURATION_SEC=\$DURATION_SEC
            NOW=\$NOW
            EOF
            "

      - name: Load stats and Send to Telegram
        run: |
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°
          source report-stats.env

          URL="https://baisaganov.github.io/hub/"
          TEXT="
            ðŸ“Š <b>Allure report update at $NOW</b>
            
            ðŸŸ¢Passed: $PASSED
            ðŸ”´Failed: $FAILED
            ðŸ”˜Skipped: $SKIPPED
            ðŸŸ¡ï¸Broken: $BROKEN
            ðŸ•’Duration: $DURATION_MIN:$DURATION_SEC
            Link: $URL
            "

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id=-1002962410919 \
          -d text="$TEXT" \
          -d parse_mode="HTML"

#      - name: Parse Allure report stats
#        run: |
#          sudo docker-compose run tests /bin/sh -c "sudo apt-get update && sudo apt-get install -y jq
#          STAT=$(cat allure-report/widgets/summary.json)
#          PASSED=$(echo '$STAT' | jq '.statistic.passed')
#          FAILED=$(echo '$STAT' | jq '.statistic.failed')
#          SKIPPED=$(echo '$STAT' | jq '.statistic.skipped')
#          BROKEN=$(echo '$STAT' | jq '.statistic.broken')
#          DURATION_MS=$(echo '$STAT' | jq '.time.duration')
#          DURATION_MIN=$((DURATION_MS / 1000 / 60))
#          DURATION_SEC=$(((DURATION_MS - DURATION_MIN * 60 * 1000) / 1000))
#          NOW=$(date -d '+5 hours' +'%Y-%m-%d %H:%M:%S')
#          echo 'PASSED=$PASSED' >> $GITHUB_ENV
#          echo "FAILED=$FAILED' >> $GITHUB_ENV
#          echo 'SKIPPED=$SKIPPED' >> $GITHUB_ENV
#          echo 'BROKEN=$BROKEN' >> $GITHUB_ENV
#          echo 'DURATION_MIN=$DURATION_MIN' >> $GITHUB_ENV
#          echo 'DURATION_SEC=$DURATION_SEC' >> $GITHUB_ENV
#          echo 'NOW=$NOW' >> $GITHUB_ENV"