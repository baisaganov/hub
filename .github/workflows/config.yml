name: Tests

on: [push]

env:
  HEADLESS: ${{ secrets.HEADLESS }}
  BROWSER: ${{ secrets.BROWSER }}
  SLOW_MO: ${{ secrets.SLOW_MO }}
  TIMEOUT: ${{ secrets.TIMEOUT }}
  NAVIGATION_TIMEOUT: ${{ secrets.NAVIGATION_TIMEOUT }}
  VIEWPORT_WIDTH: ${{ secrets.VIEWPORT_WIDTH }}
  VIEWPORT_HEIGHT: ${{ secrets.VIEWPORT_HEIGHT }}
  USER_AGENT: ${{ secrets.USER_AGENT }}
  LOCALE: ${{ secrets.LOCALE }}
  TIMEZONE: ${{ secrets.TIMEZONE }}
  TRACE: ${{ secrets.TRACE }}
  SCREENSHOT: ${{ secrets.SCREENSHOT }}
  VIDEO: ${{ secrets.VIDEO }}
  DOWNLOADS_PATH: ${{ secrets.DOWNLOADS_PATH}}
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  API_TIMEOUT: ${{ secrets.API_TIMEOUT }}
  API_RETRY_ATTEMPTS: ${{ secrets.API_RETRY_ATTEMPTS }}
  API_RETRY_DELAY: ${{ secrets.API_RETRY_DELAY }}
  BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
  ADMIN_URL: ${{ secrets.ADMIN_URL }}
  ENV: ${{ secrets.ENV }}
  LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
  TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
  TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
  API_TOKEN: ${{ secrets.API_TOKEN }}
  ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Tests via docker compose
        run: docker compose up --exit-code-from tests

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results

  generate-report:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Get Allure history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy to Github Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Send to Telegram
        continue-on-error: true
        run: |
          apt-get update && apt-get install -y jq

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ³Ğ´Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ñ„Ğ°Ğ¹Ğ»
          find allure-history -name "summary.json" -type f

          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ
          STAT=$(cat allure-history/latest/data/statistics.json 2>/dev/null || cat allure-history/0/data/statistics.json 2>/dev/null || echo '{}')

          PASSED=$(echo "$STAT" | jq '.total' 2>/dev/null || echo "0")
          FAILED=$(echo "$STAT" | jq '.failed' 2>/dev/null || echo "0")
          SKIPPED=$(echo "$STAT" | jq '.skipped' 2>/dev/null || echo "0")
          BROKEN=$(echo "$STAT" | jq '.broken' 2>/dev/null || echo "0")
          NOW=$(date -d "+5 hours" +"%Y-%m-%d %H:%M:%S")

          URL="https://baisaganov.github.io/hub/"
          TEXT="ğŸ“Š <b>Allure report updated at $NOW</b>%0A%0AğŸŸ¢Passed: $PASSED%0AğŸ”´Failed: $FAILED%0AğŸ”˜Skipped: $SKIPPED%0AğŸŸ¡ï¸Broken: $BROKEN%0ALink: $URL"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=-1002962410919" \
            -d "text=$TEXT" \
            -d "parse_mode=HTML"